name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:   # <-- allows manual runs from Actions UI

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fail if any test.only/describe.only present
        # Prevent accidental commits with `.only`. Adjust paths if test files live elsewhere.
        run: |
          set -e
          echo "Scanning for test.only / describe.only..."
          if git grep -n --break --heading -E '\b(test|describe)\.only\b' -- ':!node_modules' ; then
            echo "::error::Found a '.only' in tests. Remove it before running CI."
            exit 1
          else
            echo "No '.only' found."
          fi
        shell: bash

      - name: Use Node.js LTS
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Create .env.qa from secrets
        # This creates .env.qa at repo root from QA_ENV_FILE secret (preferred).
        # If QA_ENV_FILE is empty, it falls back to composing from individual secrets.
        run: |
          set -euo pipefail
          # Option A: whole file as single secret
          if [ -n "${{ secrets.QA_ENV_FILE || '' }}" ]; then
            echo "Writing QA_ENV_FILE secret to .env.qa (contents are masked in logs)."
            printf '%s\n' "${{ secrets.QA_ENV_FILE }}" > .env.qa
          else
            # Option B: Compose from individual secrets (uncomment or add as needed)
            echo "Composing .env.qa from individual secrets."
            : > .env.qa
            # Example keys - add or remove lines to match what your tests expect
            if [ -n "${{ secrets.QA_API_URL || '' }}" ]; then
              echo "API_URL=${{ secrets.QA_API_URL }}" >> .env.qa
            fi
            if [ -n "${{ secrets.QA_API_KEY || '' }}" ]; then
              echo "API_KEY=${{ secrets.QA_API_KEY }}" >> .env.qa
            fi
            if [ -n "${{ secrets.QA_SESSION_COOKIE || '' }}" ]; then
              echo "SESSION_COOKIE=${{ secrets.QA_SESSION_COOKIE }}" >> .env.qa
            fi
            # add more keys here as required by your app:
            # echo "OTHER_KEY=${{ secrets.OTHER_KEY }}" >> .env.qa
          fi

          # show minimal info (no secrets): print file exists and size
          echo ".env.qa created, size:"
          ls -l .env.qa
        shell: bash

      - name: Run Playwright tests (qa)
        env:
          NODE_ENV: qa        # if your project uses NODE_ENV to choose .env.qa
          # any other non-sensitive envs needed
        run: npx playwright test
        shell: bash

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
